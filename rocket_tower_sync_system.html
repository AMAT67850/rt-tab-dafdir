<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket Tower - Syst√®me de Synchronisation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            padding-top: 2rem;
        }

        .sync-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .sync-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 2rem;
            text-align: center;
        }

        .sync-header h1 {
            margin: 0;
            font-weight: 700;
            font-size: 2.5rem;
        }

        .sync-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

        .status-container {
            padding: 2rem;
            border-bottom: 1px solid #eee;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .status-synced {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .status-pending {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
        }

        .status-error {
            background: linear-gradient(135deg, #d63031, #e84393);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .stat-box {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(116, 185, 255, 0.3);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .actions-container {
            padding: 2rem;
            border-bottom: 1px solid #eee;
        }

        .action-btn {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            margin: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(162, 155, 254, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(162, 155, 254, 0.4);
            color: white;
        }

        .action-btn:disabled {
            opacity: 0.6;
            transform: none;
            box-shadow: 0 8px 25px rgba(162, 155, 254, 0.2);
        }

        .btn-export {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }

        .btn-import {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }

        .btn-compare {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }

        .btn-reset {
            background: linear-gradient(135deg, #d63031, #e84393);
        }

        .log-container {
            padding: 2rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 10px;
            border-left: 4px solid;
        }

        .log-success {
            background: #d4edda;
            border-left-color: #00b894;
            color: #155724;
        }

        .log-error {
            background: #f8d7da;
            border-left-color: #d63031;
            color: #721c24;
        }

        .log-warning {
            background: #fff3cd;
            border-left-color: #fdcb6e;
            color: #856404;
        }

        .log-info {
            background: #cce7ff;
            border-left-color: #74b9ff;
            color: #004085;
        }

        .navigation-container {
            padding: 2rem;
            text-align: center;
        }

        .nav-btn {
            background: linear-gradient(135deg, #636e72, #2d3436);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            margin: 0.25rem;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }

        .timestamp {
            font-size: 0.8rem;
            opacity: 0.7;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="sync-card">
                    <!-- Header -->
                    <div class="sync-header">
                        <h1>üöÄ Rocket Tower</h1>
                        <p>Syst√®me de Synchronisation Multi-Utilisateurs</p>
                    </div>

                    <!-- Status -->
                    <div class="status-container">
                        <div id="syncStatus" class="status-indicator status-pending">
                            ‚è≥ V√©rification de l'√©tat de synchronisation...
                        </div>
                        
                        <div class="stats-grid" id="statsGrid">
                            <!-- Statistiques g√©n√©r√©es dynamiquement -->
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="actions-container">
                        <h4 class="mb-4">üéõÔ∏è Actions de Synchronisation</h4>
                        
                        <div class="row">
                            <div class="col-md-6 text-center">
                                <button id="exportBtn" class="action-btn btn-export" onclick="syncExport()">
                                    üì§ Exporter Donn√©es
                                </button>
                                <br><small class="text-muted">T√©l√©charge un fichier JSON avec toutes vos donn√©es</small>
                            </div>
                            <div class="col-md-6 text-center">
                                <button id="importBtn" class="action-btn btn-import" onclick="syncImport()">
                                    üì• Importer Donn√©es
                                </button>
                                <br><small class="text-muted">Charge des donn√©es depuis un fichier JSON</small>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row">
                            <div class="col-md-4 text-center">
                                <button id="syncButton" class="action-btn" onclick="lancerSynchronisation()">
                                    ‚ö° Synchroniser
                                </button>
                            </div>
                            <div class="col-md-4 text-center">
                                <button class="action-btn btn-compare" onclick="syncCompare()">
                                    üîç Comparer
                                </button>
                            </div>
                            <div class="col-md-4 text-center">
                                <button class="action-btn btn-reset" onclick="resetLocal()">
                                    üóëÔ∏è Reset Local
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Journal -->
                    <div class="log-container">
                        <h5 class="mb-3">üìã Journal des Op√©rations</h5>
                        <div id="logContainer">
                            <!-- Logs g√©n√©r√©s dynamiquement -->
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="navigation-container">
                        <h6 class="mb-3">üß≠ Navigation Modules</h6>
                        <a href="index.html" class="nav-btn">üè† Dashboard</a>
                        <a href="rt_module2_recettes_crud_final.html" class="nav-btn">üí∞ Recettes</a>
                        <a href="rt_module3_charges_crud.html" class="nav-btn">üìä Charges R√©currentes</a>
                        <a href="rt_Module4_charges-periodiques_crud.html" class="nav-btn">üìÖ Charges P√©riodiques</a>
                        <a href="rt_module5_analytics.html" class="nav-btn">üìà Analytics</a>
                        <a href="rt_Module7_Previsionnel.html" class="nav-btn">üîÆ Pr√©visionnel</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== √âTAT DE SYNCHRONISATION ==========
        let syncState = {
            status: 'idle', // idle, syncing, synced, error
            lastSync: null,
            local: {
                recettes: 0,
                chargesRecurrentes: 0,
                chargesPeriodiques: 0
            },
            cloud: {
                recettes: 0,
                chargesRecurrentes: 0,
                chargesPeriodiques: 0
            },
            pending: {
                recettes: 0,
                chargesRecurrentes: 0,
                chargesPeriodiques: 0
            }
        };

        // ========== FONCTIONS UTILITAIRES ==========
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `
                ${message}
                <span class="timestamp">${timestamp}</span>
            `;
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Garder seulement les 20 derniers logs
            while (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function chargerDonneesLocales() {
            try {
                const recettes = JSON.parse(localStorage.getItem('recettesRT') || '[]');
                const chargesRecurrentes = JSON.parse(localStorage.getItem('chargesRecurrentesRT') || '[]');
                const chargesPeriodiques = JSON.parse(localStorage.getItem('chargesPeriodiquesRT') || '[]');
                
                syncState.local = {
                    recettes: recettes.length,
                    chargesRecurrentes: chargesRecurrentes.length,
                    chargesPeriodiques: chargesPeriodiques.length
                };
                
                // Simulation donn√©es cloud (dans un vrai sc√©nario, √ßa viendrait de SeaTable)
                syncState.cloud = { ...syncState.local };
                syncState.pending = { recettes: 0, chargesRecurrentes: 0, chargesPeriodiques: 0 };
                
                // Charger timestamp derni√®re sync
                const lastSyncStored = localStorage.getItem('lastSyncRT');
                if (lastSyncStored) {
                    syncState.lastSync = new Date(lastSyncStored);
                }
                
            } catch (error) {
                addLog(`‚ùå Erreur chargement donn√©es : ${error.message}`, 'error');
            }
        }

        async function testerConnexionSeaTable() {
            // Simulation test connexion
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Dans un vrai sc√©nario, ici on testerait la connexion API SeaTable
                    resolve(Math.random() > 0.3); // 70% de succ√®s simul√©
                }, 1000);
            });
        }

        function mettreAJourInterface() {
            // Mettre √† jour le statut
            const statusElement = document.getElementById('syncStatus');
            const now = new Date();
            
            if (syncState.status === 'synced' && syncState.lastSync) {
                const timeDiff = now - syncState.lastSync;
                const minutes = Math.floor(timeDiff / 60000);
                statusElement.className = 'status-indicator status-synced';
                statusElement.innerHTML = `‚úÖ Synchronis√© (il y a ${minutes} min)`;
            } else if (syncState.status === 'pending') {
                statusElement.className = 'status-indicator status-pending';
                statusElement.innerHTML = '‚è≥ Synchronisation requise';
            } else if (syncState.status === 'error') {
                statusElement.className = 'status-indicator status-error';
                statusElement.innerHTML = '‚ùå Erreur de synchronisation';
            } else {
                statusElement.className = 'status-indicator status-pending';
                statusElement.innerHTML = '‚è≥ V√©rification...';
            }

            // Mettre √† jour les statistiques
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${syncState.local.recettes}</div>
                    <div class="stat-label">Recettes (local)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${syncState.local.chargesRecurrentes}</div>
                    <div class="stat-label">Charges R√©c. (local)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${syncState.local.chargesPeriodiques}</div>
                    <div class="stat-label">Charges P√©r. (local)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${syncState.pending.recettes}</div>
                    <div class="stat-label">Recettes (√† sync)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${syncState.pending.chargesRecurrentes}</div>
                    <div class="stat-label">Charges R√©c. (√† sync)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${syncState.pending.chargesPeriodiques}</div>
                    <div class="stat-label">Charges P√©r. (√† sync)</div>
                </div>
            `;
        }

        // ========== FONCTIONS DE SYNCHRONISATION AM√âLIOR√âES ==========
        
        // üì§ EXPORT AUTOMATIQUE - NOUVELLE VERSION
        async function syncExport() {
            const exportBtn = document.getElementById('exportBtn');
            exportBtn.disabled = true;
            exportBtn.innerHTML = '‚è≥ Export en cours...';
            
            try {
                addLog('üöÄ D√©marrage export automatique...', 'info');
                
                // R√©cup√©rer toutes les donn√©es localStorage
                const donnees = {
                    version: "1.0",
                    dateExport: new Date().toISOString(),
                    systeme: "Rocket Tower",
                    recettes: JSON.parse(localStorage.getItem('recettesRT') || '[]'),
                    chargesRecurrentes: JSON.parse(localStorage.getItem('chargesRecurrentesRT') || '[]'),
                    chargesPeriodiques: JSON.parse(localStorage.getItem('chargesPeriodiquesRT') || '[]')
                };
                
                // Calculer statistiques
                const totalEnregistrements = donnees.recettes.length + donnees.chargesRecurrentes.length + donnees.chargesPeriodiques.length;
                
                addLog(`üìä Donn√©es pr√©par√©es : ${totalEnregistrements} enregistrements au total`, 'info');
                
                // Cr√©er le fichier et forcer le t√©l√©chargement
                const blob = new Blob([JSON.stringify(donnees, null, 2)], {
                    type: 'application/json'
                });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `rocket-tower-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Nettoyer l'URL
                URL.revokeObjectURL(link.href);
                
                addLog(`‚úÖ Export r√©ussi ! Fichier t√©l√©charg√© (${Math.round(blob.size / 1024)} KB)`, 'success');
                
            } catch (error) {
                addLog(`‚ùå Erreur export : ${error.message}`, 'error');
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = 'üì§ Exporter Donn√©es';
            }
        }

        // üì• IMPORT AUTOMATIQUE - NOUVELLE VERSION
        async function syncImport() {
            addLog('üì• S√©lection fichier d\'import...', 'info');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) {
                    addLog('‚ùå Aucun fichier s√©lectionn√©', 'warning');
                    return;
                }
                
                addLog(`üìÑ Fichier s√©lectionn√© : ${file.name} (${Math.round(file.size / 1024)} KB)`, 'info');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const donnees = JSON.parse(e.target.result);
                        
                        // Validation structure
                        if (!donnees.version || !donnees.recettes || !donnees.chargesRecurrentes || !donnees.chargesPeriodiques) {
                            throw new Error('Structure de fichier invalide');
                        }
                        
                        addLog('‚úÖ Fichier JSON valide, import en cours...', 'info');
                        
                        // Sauvegarder les donn√©es actuelles (backup)
                        const backup = {
                            recettes: localStorage.getItem('recettesRT'),
                            chargesRecurrentes: localStorage.getItem('chargesRecurrentesRT'),
                            chargesPeriodiques: localStorage.getItem('chargesPeriodiquesRT')
                        };
                        
                        // Importer les nouvelles donn√©es
                        localStorage.setItem('recettesRT', JSON.stringify(donnees.recettes || []));
                        localStorage.setItem('chargesRecurrentesRT', JSON.stringify(donnees.chargesRecurrentes || []));
                        localStorage.setItem('chargesPeriodiquesRT', JSON.stringify(donnees.chargesPeriodiques || []));
                        
                        // Mettre √† jour timestamp
                        localStorage.setItem('lastSyncRT', new Date().toISOString());
                        
                        // Calculer statistiques import
                        const totalImporte = (donnees.recettes?.length || 0) + (donnees.chargesRecurrentes?.length || 0) + (donnees.chargesPeriodiques?.length || 0);
                        
                        addLog(`‚úÖ Import r√©ussi ! ${totalImporte} enregistrements import√©s`, 'success');
                        addLog('üîÑ Actualisation de l\'interface...', 'info');
                        
                        // Recharger les donn√©es et actualiser l'interface
                        chargerDonneesLocales();
                        mettreAJourInterface();
                        
                        // Actualisation automatique apr√®s 2 secondes
                        setTimeout(() => {
                            addLog('üöÄ Interface actualis√©e ! V√©rifiez vos modules.', 'success');
                            // Note: Dans un vrai environnement, on pourrait faire location.reload()
                        }, 2000);
                        
                    } catch (error) {
                        addLog(`‚ùå Erreur import : ${error.message}`, 'error');
                        addLog('üí° V√©rifiez que le fichier est un export Rocket Tower valide', 'warning');
                    }
                };
                
                reader.onerror = function() {
                    addLog('‚ùå Erreur lecture fichier', 'error');
                };
                
                reader.readAsText(file, 'UTF-8');
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        // ========== AUTRES FONCTIONS (CONSERV√âES INT√âGRALEMENT) ==========
        
        async function lancerSynchronisation() {
            const button = document.getElementById('syncButton');
            button.disabled = true;
            button.innerHTML = '‚è≥ Synchronisation...';
            
            try {
                addLog('üöÄ D√©marrage synchronisation compl√®te...', 'info');
                
                // Test connexion
                const connected = await testerConnexionSeaTable();
                
                if (connected) {
                    // Simulation export (car API /rows/ non fonctionnelle)
                    addLog('üì§ Simulation export vers SeaTable...', 'warning');
                    
                    // Dans un vrai sc√©nario, ici on exporterait via CSV ou autres m√©thodes
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Mise √† jour √©tat
                    syncState.cloud = { ...syncState.local };
                    syncState.pending = { recettes: 0, chargesRecurrentes: 0, chargesPeriodiques: 0 };
                    syncState.status = 'synced';
                    syncState.lastSync = new Date();
                    
                    // Sauvegarder timestamp de derni√®re sync
                    localStorage.setItem('lastSyncRT', syncState.lastSync.toISOString());
                    
                    addLog('‚úÖ Synchronisation simul√©e r√©ussie !', 'success');
                    
                } else {
                    addLog('‚ö†Ô∏è Mode local maintenu - Synchronisation diff√©r√©e', 'warning');
                    syncState.status = 'error';
                }
                
            } catch (error) {
                addLog(`‚ùå Erreur synchronisation : ${error.message}`, 'error');
                syncState.status = 'error';
            } finally {
                button.disabled = false;
                button.innerHTML = '‚ö° Synchroniser';
                mettreAJourInterface();
            }
        }

        async function syncCompare() {
            addLog('üîç Comparaison des donn√©es...', 'info');
            const comparison = `
Comparaison Donn√©es :

LOCAL :
- Recettes : ${syncState.local.recettes}
- Charges R√©currentes : ${syncState.local.chargesRecurrentes}  
- Charges P√©riodiques : ${syncState.local.chargesPeriodiques}

CLOUD (SeaTable) :
- Recettes : ${syncState.cloud.recettes}
- Charges R√©currentes : ${syncState.cloud.chargesRecurrentes}
- Charges P√©riodiques : ${syncState.cloud.chargesPeriodiques}

√Ä SYNCHRONISER :
- Recettes : ${syncState.pending.recettes}
- Charges R√©currentes : ${syncState.pending.chargesRecurrentes}
- Charges P√©riodiques : ${syncState.pending.chargesPeriodiques}
            `;
            alert(comparison);
        }

        async function resetLocal() {
            if (confirm('‚ö†Ô∏è ATTENTION !\n\nCette action va supprimer TOUTES vos donn√©es locales.\n\n√ätes-vous certain de vouloir continuer ?')) {
                try {
                    localStorage.removeItem('recettesRT');
                    localStorage.removeItem('chargesRecurrentesRT');
                    localStorage.removeItem('chargesPeriodiquesRT');
                    localStorage.removeItem('lastSyncRT');
                    
                    addLog('üóëÔ∏è Donn√©es locales supprim√©es', 'warning');
                    
                    // R√©initialiser l'√©tat
                    syncState.local = { recettes: 0, chargesRecurrentes: 0, chargesPeriodiques: 0 };
                    syncState.pending = { recettes: 0, chargesRecurrentes: 0, chargesPeriodiques: 0 };
                    syncState.status = 'idle';
                    syncState.lastSync = null;
                    
                    mettreAJourInterface();
                    
                    addLog('‚úÖ Reset termin√© - Vous pouvez importer de nouvelles donn√©es', 'info');
                    
                } catch (error) {
                    addLog(`‚ùå Erreur reset : ${error.message}`, 'error');
                }
            }
        }

        // ========== INITIALISATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ Interface de synchronisation initialis√©e', 'success');
            addLog('üí° Export/Import automatique activ√© !', 'info');
            chargerDonneesLocales();
            mettreAJourInterface();
        });
    </script>
</body>
</html>
